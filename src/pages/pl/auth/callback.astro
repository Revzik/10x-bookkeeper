---
import { createSupabaseServerInstance } from "../../../db/supabase.client";
import { getRequestEnv } from "../../../lib/env";

export const prerender = false;

/**
 * /pl/auth/callback - Supabase Auth callback handler
 */

const code = Astro.url.searchParams.get("code");
const next = Astro.url.searchParams.get("next") || "/pl/library";

// If no code provided, redirect to login with error
if (!code) {
  return Astro.redirect("/pl/login?error=invalid_callback");
}

// Create Supabase server instance
const supabase = createSupabaseServerInstance({
  cookies: Astro.cookies,
  headers: Astro.request.headers,
  env: getRequestEnv(Astro.locals),
});

// Exchange the code for a session
const { error } = await supabase.auth.exchangeCodeForSession(code);

if (error) {
  // Log minimal error info (without full stack trace)
  console.error("Auth callback failed:", error.message || "Unknown error");
  // Redirect to login with error for auth issues
  // For password reset, redirect to forgot-password instead
  const isPasswordReset = next.includes("reset-password");
  const redirectPath = isPasswordReset ? "/pl/forgot-password" : "/pl/login";
  return Astro.redirect(`${redirectPath}?error=callback_failed`);
}

// Session is now set via cookies, redirect to next destination
return Astro.redirect(next);
---
