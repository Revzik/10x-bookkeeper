---
import { createSupabaseServerInstance } from "../../db/supabase.client";
import { getRequestEnv } from "../../lib/env";

export const prerender = false;

/**
 * /auth/callback - Supabase Auth callback handler
 *
 * Handles OAuth and password recovery flows using PKCE (Proof Key for Code Exchange).
 * This endpoint receives an authorization code from Supabase and exchanges it for a session.
 *
 * Flow:
 * 1. User clicks password reset link in email (or completes OAuth flow)
 * 2. Supabase redirects to this callback with a 'code' parameter
 * 3. We exchange the code for a session (sets session cookies)
 * 4. Redirect to the 'next' parameter (default: /library)
 *
 * Query params:
 * - code: Authorization code from Supabase (required)
 * - next: Where to redirect after successful exchange (optional)
 */

const code = Astro.url.searchParams.get("code");
const callbackError = Astro.url.searchParams.get("error");
const callbackErrorCode = Astro.url.searchParams.get("error_code");
const callbackErrorDescription = Astro.url.searchParams.get("error_description");
const next = Astro.url.searchParams.get("next") || "/library";

// Handle errors from Supabase (e.g., expired links, invalid tokens)
if (callbackError) {
  // eslint-disable-next-line no-console
  console.error("Auth callback error from Supabase:", {
    error: callbackError,
    errorCode: callbackErrorCode,
    errorDescription: callbackErrorDescription,
  });

  // For password reset errors, redirect to forgot-password page
  const isPasswordReset = next.includes("reset-password");
  const redirectPath = isPasswordReset ? "/forgot-password" : "/login";
  return Astro.redirect(`${redirectPath}?error=callback_failed`);
}

// If no code provided, redirect to login with error
if (!code) {
  return Astro.redirect("/login?error=invalid_callback");
}

// Create Supabase server instance
const supabase = createSupabaseServerInstance({
  cookies: Astro.cookies,
  headers: Astro.request.headers,
  env: getRequestEnv(Astro.locals),
});

// Exchange the code for a session
const { error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);

if (exchangeError) {
  // Log minimal error info (without full stack trace)
  console.error("Auth callback failed:", exchangeError.message || "Unknown error");
  // Redirect to login with error for auth issues
  // For password reset, redirect to forgot-password instead
  const isPasswordReset = next.includes("reset-password");
  const redirectPath = isPasswordReset ? "/forgot-password" : "/login";
  return Astro.redirect(`${redirectPath}?error=callback_failed`);
}

// Session is now set via cookies, redirect to next destination
return Astro.redirect(next);
---
